# DataFlowAnalyzer
Collects the end-to-end column-level data lineage in the Data Warehouses environment 
by analyzing SQL script especially stored procedure like PL/SQL.

This tool introduces a new [data lineage model](sqlflow-data-lineage-model-reference.pdf) 
that is compatible with the Apache Atlas type system to describle the data flow of table/columns. 

This tool is built from the scratch, it is the main part of the backend of [the SQLFlow Cloud](https://sqlflow.gudusoft.com).


## Usage
```
"Usage: java DataFlowAnalyzer [/f <path_to_sql_file>] [/d <path_to_directory_includes_sql_files>] [/stat] [/s [/topselectlist] [/text] ] [/i] [/ic] [/lof] [/j] [/json] [/traceView] [/t <database type>] [/o <output file path>] [/version] [/env <path_to_metadata.json>] [/tableLineage [/csv]] [/transform [/coor]]");

System.out.println("/f: Optional, the full path to SQL file.");
System.out.println("/d: Optional, the full path to the directory includes the SQL files.");
System.out.println("/j: Optional, return the result including the join relation.");
System.out.println("/s: Optional, simple output, ignore the intermediate results.");
System.out.println("/topselectlist: Optional, simple output with top select results.");
System.out.println(
"/i: Optional, the same as /s option, but will keep the resultset generated by the SQL function.");
System.out.println(
"/if: Optional, keep all the intermediate resultset, but remove the resultset generated by the SQL function");
System.out.println("/ic: Optional, ignore the coordinates in the output.");
System.out.println("/lof: Option, link orphan column to the first table.");
System.out.println(
"/traceView: Optional, only output the name of source tables and views, ignore all intermedidate data.");
System.out.println(
"/text: Optional, this option is valid only /s is used, output the column dependency in text mode.");
System.out.println("/json: Optional, print the json format output.");
System.out.println("/stat: Optional, output the analysis statistic information.");
System.out.println("/tableLineage [/csv]: Optional, output tabel level lineage.");
System.out.println("/csv: Optional, output column level lineage in csv format.");
System.out.println("/t: Option, set the database type. "
+ "Support access,bigquery,couchbase,dax,db2,greenplum,hana,hive,impala,informix,mdx,mssql,\n"
+ "sqlserver,mysql,netezza,odbc,openedge,oracle,postgresql,postgres,redshift,snowflake,\n"
+ "sybase,teradata,soql,vertica\n, " + "the default value is oracle");
System.out.println("/o: Optional, write the output stream to the specified file.");
System.out.println("/log: Optional, generate a dataflow.log file to log information.");
System.out.println("/env: Optional, specify a metadata.json to get the database metadata information.");
System.out.println("/transform: Optional, output the relation transform code.");
System.out.println("/coor: Optional, output the relation transform coordinate, but not the code.");
System.out.println("/defaultDatabase: Optional, specify the default schema.");
System.out.println("/defaultSchema: Optional, specify the default schema.");
System.out.println("/showImplicitSchema: Optional, show implicit schema.");

```


Here is the list of available database after /t option:
```
access,bigquery,couchbase,dax,db2,greenplum,hana,hive,impala,informix,mdx,mssql,
sqlserver,mysql,netezza,odbc,openedge,oracle,postgresql,postgres,redshift,snowflake,
sybase,teradata,soql,vertica
```

## 1. Binary version
https://github.com/sqlparser/gsp_demo_java/releases/ 
> update date: 2022/10/05

In order to run this utility, please install Oracle JDK1.8 or higher on your computer correctly.
	
## 2. Analyze data linege from SQL files	
Please use `/f` parameter to specify a single SQL file,
or use `/d` parameter to specfify a directory that inculdes multiple SQL files.

```
java -jar gudusoft.dlineage.jar /t mssql /f path_to_sql_file
```

## 3. Analyze data linege from a database
Since version 2.2.0, the dlineage tool no longer connect to the database to analyze
the data lineage directly. Instead, it accepts a metadata json file which 
includes all metadata of a database and analyze the data lineage from this json file.

### 3.1 extract metdata from database

[sqlflow-ingester](https://github.com/sqlparser/sqlflow_public/releases) is a tool that extract metadata from various database,
you can download the tool here:

https://github.com/sqlparser/sqlflow_public/releases

Under linux:
```
./exporter.sh -host 127.0.0.1 -port 1521 -db orcl -user scott -pwd tiger -save /tmp/sqlflow-ingester -dbVendor dbvoracle
```

Under windows:
```
exporter.bat -host 127.0.0.1 -port 1521 -db orcl -user scott -pwd tiger -save c:\tmp\sqlflow-ingester -dbVendor dbvoracle
```

After successfully export metadta from the database, you will get a metadata.json file.

### 3.2 analyze metadata file

After you get the metadata.json file, just analyze it like a normal sql file with `/f` parmeter:
```
java -jar gudusoft.dlineage.jar /t oracle /f metadata.json
```



## 4. Resolve the ambiguous columns in SQL query
```sql
select ename
from emp, dept
where emp.deptid = dept.id
```

column `ename` in the first line is not qualified by table name `emp`, so itâ€™s ambiguous to know which table this column belongs to?

### solution 1, provides create table DDL 

Put the following DDL before the above SQL statement in the same SQL file.
the column `ename` will be linked to the table `emp` correctly.

```sql
create table emp(
	id int,
	ename char(50),
	deptid int
);

create table dept(
	id int,
	dname char(50)
);
```

### solution 2: provide metadata exported from database
Since dlineage v2.2.0 (2022/7/21), This dlineage tool supports `/env` parameter to accept a metadata json file
which includes the metadata exported from a database.

By providing metadata.json that includes the metadata, column `ename` should be linked to the table `emp` correctly.

You can use `/env` to specify a metadata.json like this:

```
java -jar gudusoft.dlineage.jar /t oracle /f path_to_sql_file /env metadata.json
```

You can always extract metadata from the database use the [sqlflow-ingester](https://github.com/sqlparser/sqlflow_public/releases) tool.

## 5. Relationship of the setting options in the SQLFlow and this demo
[sqlflow setting](./sqlflow-settings.png)

### direct dataflow (fdd), indirect dataflow (fdr)
In this demo, there is no corresponding parameter. 
You must filter out the relation types that you don't require because this dataflowAnalyzer demo will generate data lineage with all relation types, including fdd, fdr, join, and call.

### args in count function
related arg: `/treatArgumentsInCountFunctionAsDirectDataflow`

### show intermediate recordset, show function
The settings for "show intermediate recordset" and "show function" have no corresponding arguments in the demo
But by using those args, you can get the same outcome:

- don't specify any related args, this will output the same result as if you set `show intermediate recordset = true` and set `show function = true`
- /if, this will output the same result as if you set `show intermediate recordset = true` and set `show function = false`
- /i,  this will output the same result as if you set `show intermediate recordset = false` and set `show function = true` 
- /topselectlist, this will output the same result as if you set `show intermediate recordset = false` and set `show function = false` 

### show constant
/showConstant

### show transform
/transform /coor


## Releases
- [Ver2.2.0, 2022/07/21] Use /env parameter to provide metadata.
- [Ver2.1.2, 2021/07/13] Update readme, illustrates how to connect to database instance in command line.
- [Ver2.1.1, 2021/07/12] Update download, data lineage model document.
- [Ver2.1.0, 2021/07/11] Release gsp core 2.3.7.2

## Links
- [First version, 2017-8](https://github.com/sqlparser/wings/issues/494)
